# tum_lanelet2_osm_fusion

<!-- [[_TOC_]] -->

- [tum\_lanelet2\_osm\_fusion](#tum_lanelet2_osm_fusion)
  - [Overview](#overview)
  - [Configuration](#configuration)
    - [Integration in Autoware](#integration-in-autoware)
    - [Setup](#setup)
  - [How to use the package](#how-to-use-the-package)
  - [Test Data](#test-data)
  - [Visualization](#visualization)
  - [Content](#content)
  - [Contact person](#contact-person)

## Overview

![image](doc/img/conflation_tool.png)

## Configuration

### Integration in Autoware
This package is designed to be used with the [Autoware.Universe](https://github.com/autowarefoundation/autoware.universe) Framework.
Therefore, copy the whole directory into the [map directory](https://github.com/autowarefoundation/autoware.universe/tree/main/map) and build Autoware as described [here](https://autowarefoundation.github.io/autoware-documentation/main/installation/).

### Setup

Parameters used inside the package can be adjusted in `/config/lanelet2_osm.param.yaml`.\
Explanations on the parameters can be found in the comments and the documentation of the single [modules](#content).

## How to use the package

1. Installation:

   - the package is to be used in the autoware software stack
   - within the autoware environment, build the package by running

   ```shell
       colcon build --packages-up-to tum_lanelet2_osm_fusion --symlink-install --cmake-args -DCMAKE_BUILD_TYPE=Release
   ```

   in the command window.

2. Necessary input parameters:
   - `traj_path` => path to GPS trajectory of the vehicle (format: txt-file with lat, lon)
   - `poses_path` => path to SLAM trajectory of the vehicle (KITTI-format, trajectories don't have to be synchronized over time)
   - `map_path` => path to lanelet2 map corresponding to trajectories (map can have missing elements/attributes)
   - `out_path` => path to saved the modified lanelet map (DEFAULT: /lanelet2_map.osm)
3. Start the package

   - it is recommended to directly use the provided ROS launch file that starts the package itself and the visualization in RVIZ:

   ```shell
       ros2 launch tum_lanelet2_osm_fusion lanelet2_osm.launch.py traj_path:=<path-to-GPS-trajectory> poses_path:=<path-to-SLAM-trajectory>  map_path:=<path-to-lanelet-map> out_path:=<path-to-save-output-map>
   ```

   - the launch file directly links to the parameter file in `/config/lanelet2_osm.param.yaml`.
   - if you do not provide any input parameters when using the launch file & are in the package directory, the exemplary input files in `/test` are used. See below for more information.
   - If you do not want to use the launch file, you can start the package by running:

   ```shell
       ros2 run tum_lanelet2_osm_fusion lanelet2_osm --ros-args -p traj_path:=<path-to-GPS-trajectory> -p poses_path:=<path-to-SLAM-trajectory> -p map_path:=<path-to-lanelet-map> -p out_path:=<path-to-save-output-map> --params-file <path-to-param-file>
   ```

   => keep in mind that you have to start RVIZ and visualize the topics described above to further use the package (see points below).

4. Select control points
   - after the trajectories are loaded and the target trajectory is roughly aligned to the master trajectory you are asked in the command window to select control points for the rubber-sheet transformation (the amount of points can be configured).
   - select the desired points using the `Publish Point` button in RVIZ and follow the instructions in the console.
5. Inspect results
   - results of the rubber-sheet transformation & lanelet map are visualized.
   - Inspect results and modify parameters if desired.
6. Manually finalize lanelet map
   - open a manual editor for lanelet2 maps (e.g. [VectorMapBuilder](https://tools.tier4.jp/feature/vector_map_builder_ll2/)) in parallel to RVIZ
   - import the exported map from `out_path`
   - close gaps in lanelet map and correct other mistakes based on visualization of map agreement with [OpenStreetMap](openstreetmap.org/) in RVIZ

## Test Data

The test data in `/test` is from the EDGAR research vehicle (GPS trajectory). The SLAM poses are generated by [KISS-ICP](https://github.com/PRBonn/kiss-icp) in combination with [interactive SLAM](https://github.com/SMRT-AIST/interactive_slam). The lanelet2-map is created manually with [VectorMapBuilder](https://tools.tier4.jp/feature/vector_map_builder_ll2/) by TieriV.

## Visualization

Several ROS topics are published that can be visualized in RVIZ. The following table gives an overview of the topic and its description.
| Topic | Description |
| ----------- | ----------- |
| `/lof/map/osm_map_markers` | Street network downloaded from [OpenStreetMap](openstreetmap.org/). |
| `/lof/map/ll_map_markers` | Lanelet2-map enriched with attributes from [OpenStreetMap](openstreetmap.org/); Lanelets are colorized based on agreement between adjacent lanelets and lanes-tag of [OpenStreetMap](openstreetmap.org/). |
| `/lof/map/ll_map_new_markers` | Lanelet2-map enriched with attributes from [OpenStreetMap](openstreetmap.org/); Lanelets that are likely to be wrong were removed. |
| `/lof/traj/traj_master_markers` | Master trajectory -> to be defined in config-file (either GNSS- or SLAM trajectory) |
| `/lof/traj/traj_target_markers` | original target rajectory -> depending on selected master trajectory (either GNSS- or SLAM trajectory) |
| `/lof/traj/traj_align_markers` | target trajectory aligned to master with [Umeyama](https://web.stanford.edu/class/cs273/refs/umeyama.pdf) transformation or [PCL ICP](https://pointclouds.org/documentation/classpcl_1_1_iterative_closest_point.html) |
| `/lof/traj/traj_rs_markers` | target trajectory after [rubber-sheet](https://www.tandfonline.com/doi/abs/10.1559/152304085783915135)-transformation |
| `/lof/rs/geom_markers` | geometric information from rubber-sheeting (control points and constructed triangles) |
| `/clicked_point` | last 2 selected points by user to indicate chosen control point |
| `/lof/confl/geom_markers` | geometric information regarding conflation process (collapsed lanelet-map, buffers, matches) |

## Content

Detailed documentation of the modules can be found below.

1. [Geometric Alignment](doc/alignment.md)

2. [Preprocessing](doc/preprocessing.md)

3. [Matching](doc/matching.md)

4. [Conflation](doc/conflation.md)

5. [Analysis](doc/analysis.md)

## Contact person

[Maximilian Leitenstern](mailto:maxi.leitenstern@tum.de)
